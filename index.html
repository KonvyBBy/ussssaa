<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Konvy Accounts</title>
<style>
:root{ --bg:#000; --fg:#fff; --muted:#bdbdbd; --accent:#fff; --green:#0f0; --red:#f33; --orange:#f90; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:var(--fg);background:var(--bg);}
body{display:flex;flex-direction:column;}
header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid rgba(255,255,255,0.1);}
.logo{font-size:24px;font-weight:700;}
main{flex:1;display:flex;overflow:hidden;}
.sidebar{width:250px;background:rgba(255,255,255,0.05);padding:20px;display:flex;flex-direction:column;gap:12px;}
.sidebar button{background:transparent;border:1px solid rgba(255,255,255,0.1);padding:10px;border-radius:8px;color:var(--fg);cursor:pointer;text-align:left;font-weight:600;}
.sidebar button.active{background:var(--accent);color:var(--bg);}
.content{flex:1;padding:24px;overflow-y:auto;}
h2{margin-top:0;color:var(--accent);}
.card{background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;margin-bottom:12px;}
input,button,textarea{font-size:14px;}
input[type=text],input[type=password],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:var(--fg);}
button{padding:10px;border:none;border-radius:8px;background:var(--fg);color:var(--bg);cursor:pointer;font-weight:700;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.2);}
.hidden{display:none;}
#auth-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;}
#auth-screen .card{max-width:360px;width:100%;padding:24px;}
.switcher{display:flex;gap:8px;margin-bottom:12px;}
.switcher button{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--fg);padding:8px;border-radius:8px;flex:1;font-weight:600;cursor:pointer;}
.switcher button.active{background:var(--accent);color:var(--bg);}
.status-used{color:var(--red);font-weight:700;}
.status-unused{color:var(--green);font-weight:700;}
.status-pending{color:var(--orange);font-weight:700;}
.delete-btn{background:red;color:#fff;padding:2px 6px;border-radius:4px;font-size:12px;cursor:pointer;}
/* Chat styles */
#chat-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  overflow: hidden;
}
#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: rgba(255,255,255,0.05);
}
.message {
  margin-bottom: 10px;
}
.message.both {
  background: rgba(255, 255, 255, 0.1);
  padding: 8px;
  border-radius: 6px;
}
.message.user {
  background: rgba(0, 255, 0, 0.2);
  align-self: flex-start;
}
.message.owner {
  background: rgba(255, 0, 0, 0.2);
  align-self: flex-end;
}
#message-input-container {
  display: flex;
  padding: 10px;
  background: rgba(255,255,255,0.05);
}
#message-input {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.2);
  background: transparent;
  color: var(--fg);
}
#send-btn {
  margin-left: 8px;
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  background: var(--fg);
  color: var(--bg);
  cursor: pointer;
  font-weight: 700;
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="card">
    <h2>Sign In / Sign Up</h2>
    <div class="switcher">
      <button id="btn-login" class="active">Login</button>
      <button id="btn-signup">Sign Up</button>
    </div>

    <form id="login-form">
      <label>Email</label>
      <input type="text" id="login-email" placeholder="you@example.com" required>
      <label>Password</label>
      <input type="password" id="login-password" placeholder="password" required>
      <button type="submit">Sign In</button>
    </form>

    <form id="signup-form" class="hidden">
      <label>Username</label>
      <input type="text" id="signup-username" placeholder="Username" required>
      <label>Email</label>
      <input type="text" id="signup-email" placeholder="you@example.com" required>
      <label>Password</label>
      <input type="password" id="signup-password" placeholder="password" required>
      <button type="submit">Sign Up</button>
    </form>
  </div>
</div>

<header>
  <div class="logo">Konvy</div>
  <div>
    <span id="welcome">Welcome</span> | <span id="user-email">Not signed in</span>
    <button id="logout-btn" class="hidden">Logout</button>
  </div>
</header>

<main>
  <div class="sidebar">
    <button id="menu-dashboard" class="active">Dashboard</button>
    <button id="menu-redeem">Redeem Key</button>
    <button id="menu-orders">My Orders</button>
    <button id="menu-inbox">Inbox</button>
    <button id="menu-owner" class="hidden">Owner Panel</button>
  </div>
  <div class="content" id="main-content">
    <!-- Dashboard -->
    <div id="dashboard-view">
      <h2>Dashboard</h2>
      <div class="card">Welcome to your account dashboard.</div>
    </div>
    <!-- Redeem -->
    <div id="redeem-view" class="hidden">
      <h2>Redeem Key</h2>
      <div class="card">
        <input type="text" id="redeem-key-input" placeholder="Enter product key">
        <button id="redeem-key-btn">Redeem</button>
      </div>
    </div>
    <!-- Orders -->
    <div id="orders-view" class="hidden">
      <h2>My Orders</h2>
      <table>
        <thead><tr><th>Product</th><th>Redeemed At</th><th>Status</th></tr></thead>
        <tbody id="orders-list"></tbody>
      </table>
    </div>
    <!-- Inbox -->
    <div id="inbox-view" class="hidden" style="display:flex; flex-direction:column; height:100%;">
      <h2>Inbox</h2>
      <div id="conversations" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
      <div id="chat-container" style="display:flex; flex-direction:column; height:300px;">
        <div id="messages"></div>
        <div id="message-input-container">
          <input type="text" id="message-input" placeholder="Type your message...">
          <button id="send-btn">Sendd</button>
        </div>
      </div>
    </div>
    <!-- Owner Panel -->
    <div id="owner-view" class="hidden">
      <h2>Owner Panel</h2>
      <div class="card">
        <h4>Create Key</h4>
        <input type="text" id="owner-product-name" placeholder="Product Name">
        <input type="text" id="owner-key" placeholder="Key">
        <button id="create-key-btn">Create Key</button>
      </div>
      <div class="card">
        <h4>All Keys</h4>
        <input type="text" id="search-keys" placeholder="Search keys...">
        <table>
          <thead><tr><th>Key</th><th>Product</th><th>Status</th><th>Redeemed By</th><th>Delete</th></tr></thead>
          <tbody id="keys-list"></tbody>
        </table>
      </div>
      <div class="card">
        <h4>All Conversations</h4>
        <div id="owner-conversations" style="max-height:300px; overflow-y:auto; border:1px solid rgba(255,255,255,0.2); padding:8px; border-radius:8px;"></div>
      </div>
    </div>
  </div>
</main>

<footer>Built with Firebase â€” works across devices.</footer>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD2M35gv68ILULRqlRVlO5E4oLCXbj1RaM",
  authDomain: "konvy-57910.firebaseapp.com",
  projectId: "konvy-57910",
  storageBucket: "konvy-57910.firebasestorage.app",
  messagingSenderId: "97699914787",
  appId: "1:97699914787:web:f2ba164292f3a3f07ebd96",
  measurementId: "G-330N3W9E4N"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elements
const btnLogin = document.getElementById("btn-login");
const btnSignup = document.getElementById("btn-signup");
const loginForm = document.getElementById("login-form");
const signupForm = document.getElementById("signup-form");
const authScreen = document.getElementById("auth-screen");
const welcomeEl = document.getElementById("welcome");
const userEmailEl = document.getElementById("user-email");
const logoutBtn = document.getElementById("logout-btn");
const dashboardView=document.getElementById('dashboard-view');
const redeemView=document.getElementById('redeem-view');
const ordersView=document.getElementById('orders-view');
const inboxView=document.getElementById('inbox-view');
const ownerView=document.getElementById('owner-view');
const redeemInput=document.getElementById('redeem-key-input');
const redeemBtn=document.getElementById('redeem-key-btn');
const ordersList=document.getElementById('orders-list');
const ownerControlsBtn=document.getElementById('menu-owner');
const ownerProductName=document.getElementById('owner-product-name');
const ownerKeyInput=document.getElementById('owner-key');
const createKeyBtn=document.getElementById('create-key-btn');
const keysList=document.getElementById('keys-list');
const searchKeys=document.getElementById('search-keys');
const conversationsDiv=document.getElementById('conversations');
const ownerConversationsDiv=document.getElementById('owner-conversations');
const messageInput=document.getElementById('message-input');
const sendBtn=document.getElementById('send-btn');

const OWNER_KEY="KDFIHFdawdd124345#$@#FIGwdwdaHE@";

// Switch views
function switchView(view){
  document.querySelectorAll('#main-content > div').forEach(d=>d.classList.add('hidden'));
  document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
  if(view==='dashboard'){document.getElementById('dashboard-view').classList.remove('hidden'); document.getElementById('menu-dashboard').classList.add('active');}
  if(view==='redeem'){document.getElementById('redeem-view').classList.remove('hidden'); document.getElementById('menu-redeem').classList.add('active');}
  if(view==='orders'){document.getElementById('orders-view').classList.remove('hidden'); document.getElementById('menu-orders').classList.add('active'); loadOrders();}
  if(view==='inbox'){document.getElementById('inbox-view').classList.remove('hidden'); document.getElementById('menu-inbox').classList.add('active'); loadConversations();}
  if(view==='owner'){document.getElementById('owner-view').classList.remove('hidden'); document.getElementById('menu-owner').classList.add('active'); loadKeys(); loadOwnerConversations();}
}

// Signup & Login toggle
document.getElementById("btn-login").onclick=()=>{document.getElementById("login-form").style.display='block'; document.getElementById("signup-form").style.display='none';};
document.getElementById("btn-signup").onclick=()=>{document.getElementById("signup-form").style.display='block'; document.getElementById("login-form").style.display='none';};

// Signup
document.getElementById("signup-form").addEventListener("submit", async e=>{
  e.preventDefault();
  const email=document.getElementById("signup-email").value.trim();
  const password=document.getElementById("signup-password").value;
  const username=document.getElementById("signup-username").value.trim();
  try{
    const cred=await auth.createUserWithEmailAndPassword(email,password);
    await db.collection("users").doc(cred.user.uid).set({username, role:"user"});
    alert("Signup successful");
  }catch(e){ alert(e.message);}
});
// Login
document.getElementById("login-form").addEventListener("submit", async e=>{
  e.preventDefault();
  const email=document.getElementById("login-email").value.trim();
  const password=document.getElementById("login-password").value;
  try{
    await auth.signInWithEmailAndPassword(email,password);
  }catch(e){ alert(e.message);}
});
// Logout
document.getElementById("logout-btn").onclick=()=>auth.signOut();

// Redeem Key
document.getElementById("redeem-key-btn").onclick=async ()=>{
  const key=redeemInput.value.trim();
  const user=auth.currentUser;
  if(!key || !user) return alert("Enter key");
  const keyDoc=await db.collection("keys").doc(key).get();
  if(!keyDoc.exists) return alert("Invalid key");
  const data=keyDoc.data();
  if(data.used) return alert("Key already used");
  if(key===OWNER_KEY){
    await db.collection("users").doc(user.uid).update({role:"owner"});
    alert("You are now owner");
    loadKeys();
    return;
  }
  await db.collection("keys").doc(key).update({used:true, redeemedBy:user.uid});
  await db.collection("orders").add({uid:user.uid, product:data.product, redeemedAt:new Date(), status:"Pending", key:key});
  alert(`Redeemed ${data.product}`);
  loadOrders();
  loadKeys();
};

// Load Orders
async function loadOrders(){
  ordersList.innerHTML="";
  const user=auth.currentUser;
  if(!user) return;
  const snap=await db.collection("orders").where("uid","==",user.uid).get();
  if(snap.empty){ordersList.innerHTML="<tr><td colspan='3' style='color:var(--muted)'>No orders yet</td></tr>";return;}
  snap.forEach(doc=>{
    const d=doc.data();
    const statusColor=d.status==="Pending"?"status-pending":"status-unused";
    const row=document.createElement("tr");
    row.innerHTML=`<td>${d.product}</td><td>${new Date(d.redeemedAt.seconds*1000).toLocaleString()}</td><td class="${statusColor}">${d.status}</td>`;
    ordersList.appendChild(row);
  });
}

// Load Keys
async function loadKeys(){
  document.getElementById("keys-list").innerHTML="";
  const snap=await db.collection("keys").get();
  snap.forEach(doc=>{
    const d=doc.data();
    const row=document.createElement("tr");
    const statusClass=d.used?"status-used":"status-unused";
    row.innerHTML=`<td>${doc.id}</td><td>${d.product}</td><td class="${statusClass}">${d.used?"Used":"Unused"}</td><td>${d.redeemedBy||"-"}</td><td><button class="delete-btn" data-key="${doc.id}">Delete</button></td>`;
    document.getElementById("keys-list").appendChild(row);
  });
  document.querySelectorAll(".delete-btn").forEach(btn=>{
    btn.onclick=async ()=>{
      if(confirm("Delete key?")){
        await db.collection("keys").doc(btn.dataset.key).delete();
        loadKeys();
      }
    };
  });
}

// Create Key
document.getElementById("create-key-btn").onclick=async ()=>{
  const product=ownerProductName.value.trim();
  const key=ownerKeyInput.value.trim();
  if(!product || !key) return alert("Enter product and key");
  const exists=await db.collection("keys").doc(key).get();
  if(exists.exists) return alert("Key exists");
  await db.collection("keys").doc(key).set({product, used:false});
  ownerProductName.value="";
  ownerKeyInput.value="";
  loadKeys();
  alert("Key created");
};

// Search keys
document.getElementById("search-keys").addEventListener("input", ()=>{
  const filter=document.getElementById("search-keys").value.toLowerCase();
  document.querySelectorAll("#keys-list tr").forEach(tr=>{
    tr.style.display=tr.textContent.toLowerCase().includes(filter)?"":"none";
  });
});

// --- Messaging System ---

// Load user conversations
async function loadConversations(){
  document.getElementById("conversations").innerHTML="";
  const user=auth.currentUser;
  if(!user) return;
  const snap=await db.collection("conversations").where("uid","==",user.uid).get();
  snap.forEach(doc=>{
    const data=doc.data();
    const convDiv=document.createElement("div");
    convDiv.style.border="1px solid rgba(255,255,255,0.2)";
    convDiv.style.borderRadius="8px";
    convDiv.style.padding="8px";
    convDiv.style.marginBottom="8px";
    convDiv.style.cursor="pointer";
    convDiv.innerHTML=`<b>${data.product} (${data.key})</b> - ${data.status}`;
    convDiv.onclick=()=>loadChat(doc.id, data);
    document.getElementById("conversations").appendChild(convDiv);
  });
}

// Load owner conversations
async function loadOwnerConversations(){
  ownerConversationsDiv.innerHTML="";
  const snap=await db.collection("conversations").get();
  snap.forEach(doc=>{
    const data=doc.data();
    const convDiv=document.createElement("div");
    convDiv.style.border="1px solid rgba(255,255,255,0.2)";
    convDiv.style.borderRadius="8px";
    convDiv.style.padding="8px";
    convDiv.style.marginBottom="8px";
    convDiv.style.cursor="pointer";
    convDiv.innerHTML=`<b>${data.product} (${data.key})</b> - ${data.status}`;
    convDiv.onclick=()=>loadChat(doc.id, data);
    ownerConversationsDiv.appendChild(convDiv);
  });
}

// Load chat messages
async function loadChat(convId, data){
  currentConvId=convId;
  document.getElementById("messages").innerHTML="";
  // Fetch conversation
  const convRef=await db.collection("conversations").doc(convId).get();
  if(!convRef.exists) return;
  const convData=convRef.data();
  // Show messages
  if(convData.messages){
    convData.messages.sort((a,b)=>a.time.seconds - b.time.seconds);
    convData.messages.forEach(msg=>{
      const msgDiv=document.createElement("div");
      msgDiv.className="message "+(msg.sender===auth.currentUser.email?"user":"owner");
      msgDiv.innerHTML=`<b>${msg.sender}</b>: ${msg.text}`;
      document.getElementById("messages").appendChild(msgDiv);
    });
  }
  // Set current conversation for sending
  window.currentConvId=convId;
}

// Send message
document.getElementById("send-btn").onclick=async ()=>{
  const text=document.getElementById("message-input").value.trim();
  if(!text || !auth.currentUser || !currentConvId) return;
  const convRef=await db.collection("conversations").doc(currentConvId);
  const convDoc=await convRef.get();
  if(!convDoc.exists) return;
  const newMsg={
    sender:auth.currentUser.email,
    text:text,
    time:new Date()
  };
  await convRef.update({messages:firebase.firestore.FieldValue.arrayUnion(newMsg)});
  document.getElementById("message-input").value="";
  loadChat(currentConvId); // reload chat
  // refresh owner view
  loadOwnerConversations();
};

// Firebase auth state
auth.onAuthStateChanged(async user=>{
  if(user){
    document.getElementById("auth-screen").style.display='none';
    document.getElementById("welcome").textContent=`Hi, ${user.displayName||"User"}`;
    document.getElementById("user-email").textContent=user.email;
    document.getElementById("logout-btn").classList.remove("hidden");
    // Check user role
    const userDoc=await db.collection("users").doc(user.uid).get();
    const role=userDoc.exists?userDoc.data().role:"user";
    if(role==="owner"){
      document.getElementById("menu-owner").classList.remove("hidden");
    }else{
      document.getElementById("menu-owner").classList.add("hidden");
    }
    // Load data
    loadOrders();
    loadKeys();
    loadConversations();
    loadOwnerConversations();
  }else{
    document.getElementById("auth-screen").style.display='flex';
    document.querySelectorAll('#main-content > div').forEach(d=>d.classList.add('hidden'));
    document.getElementById("logout-btn").classList.add("hidden");
  }
});
</script>
</body>
</html>
