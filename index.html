<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Konvy Accounts — Full Dashboard</title>
<style>
  :root{--bg:#000;--fg:#fff;--muted:#bdbdbd}
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,sans-serif}
  body{background:var(--bg);color:var(--fg);display:flex;flex-direction:column;min-height:100vh}
  header,footer{padding:16px;text-align:center;background:rgba(255,255,255,0.03)}
  main{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:16px;gap:16px}
  .hidden{display:none}
  button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  input,select,textarea{padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#fff;width:100%}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid rgba(255,255,255,0.2);padding:6px;text-align:left}
  .green{color:green;font-weight:700}
  .red{color:red;font-weight:700}
  .orange{color:orange;font-weight:700}
  .flex{display:flex;gap:8px;align-items:center}
  textarea{resize:none}
</style>
</head>
<body>

<header>
  <h1>Konvy Accounts Dashboard</h1>
  <div id="owner-status-display">Owner Status: Offline</div>
</header>

<main>
  <!-- Auth Screen -->
  <div id="auth-screen" class="flex" style="flex-direction:column;gap:8px;">
    <input id="signup-username" placeholder="Username">
    <input id="signup-email" type="email" placeholder="Email">
    <input id="signup-password" type="password" placeholder="Password">
    <button id="signup-btn">Sign Up</button>
    <hr style="width:100%;border-color:rgba(255,255,255,0.2)">
    <input id="login-email" type="email" placeholder="Email">
    <input id="login-password" type="password" placeholder="Password">
    <button id="login-btn">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden" style="width:100%;max-width:920px;display:flex;flex-direction:column;gap:16px;">

    <div class="flex" style="justify-content:space-between;">
      <div>
        <strong id="welcome"></strong> - <span id="user-email"></span>
      </div>
      <div>
        <button id="logout-btn">Logout</button>
        <select id="owner-status" class="hidden">
          <option value="Online">Online</option>
          <option value="Offline">Offline</option>
          <option value="AFK">AFK</option>
        </select>
      </div>
    </div>

    <!-- Redeem Key -->
    <div id="redeem-section" class="flex" style="gap:8px;">
      <input id="redeem-input" placeholder="Enter Key">
      <button id="redeem-btn">Redeem Key</button>
    </div>

    <!-- Orders -->
    <div>
      <h3>My Orders</h3>
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>Key</th>
            <th>Redeemed At</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="orders-list"></tbody>
      </table>
    </div>

    <!-- Message Owner -->
    <div id="message-section">
      <h3>Message Owner</h3>
      <textarea id="message-input" rows="3" placeholder="Type a message" disabled></textarea>
      <button id="send-msg-btn" disabled>Send</button>
      <div id="messages-list" style="margin-top:8px;"></div>
    </div>

    <!-- Owner Panel -->
    <div id="owner-panel" class="hidden">
      <h3>Owner Panel</h3>

      <!-- Create Key -->
      <div class="flex" style="gap:8px;">
        <input id="owner-key-product" placeholder="Product Name">
        <input id="owner-key-code" placeholder="Key Code">
        <button id="create-key-btn">Create Key</button>
      </div>

      <!-- Keys List -->
      <h4>Keys</h4>
      <table>
        <thead>
          <tr>
            <th>Key</th>
            <th>Product</th>
            <th>Used</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="keys-list"></tbody>
      </table>

      <!-- Orders List -->
      <h4>All Orders</h4>
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Product</th>
            <th>Key</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="owner-orders-list"></tbody>
      </table>

      <!-- Tickets -->
      <h4>Tickets</h4>
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Product</th>
            <th>Key</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tickets-list"></tbody>
      </table>
    </div>

  </div>
</main>

<footer>
  Konvy Accounts Demo — Firebase Powered
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, query, where, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "YOUR-API-KEY",
  authDomain: "YOUR-PROJECT.firebaseapp.com",
  projectId: "YOUR-PROJECT",
  storageBucket: "YOUR-PROJECT.appspot.com",
  messagingSenderId: "YOUR-ID",
  appId: "YOUR-APP-ID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- Elements ---
const authScreen=document.getElementById("auth-screen");
const dashboardView=document.getElementById("dashboard");
const welcomeEl=document.getElementById("welcome");
const userEmailEl=document.getElementById("user-email");
const logoutBtn=document.getElementById("logout-btn");
const ownerStatusSelect=document.getElementById("owner-status");
const ownerStatusDisplay=document.getElementById("owner-status-display");

const signupBtn=document.getElementById("signup-btn");
const loginBtn=document.getElementById("login-btn");

const redeemInput=document.getElementById("redeem-input");
const redeemBtn=document.getElementById("redeem-btn");

const ordersList=document.getElementById("orders-list");
const messageInput=document.getElementById("message-input");
const sendMsgBtn=document.getElementById("send-msg-btn");
const messagesList=document.getElementById("messages-list");

const ownerPanel=document.getElementById("owner-panel");
const createKeyBtn=document.getElementById("create-key-btn");
const ownerKeyProduct=document.getElementById("owner-key-product");
const ownerKeyCode=document.getElementById("owner-key-code");
const keysList=document.getElementById("keys-list");
const ownerOrdersList=document.getElementById("owner-orders-list");
const ticketsList=document.getElementById("tickets-list");

// --- Auth ---
signupBtn.addEventListener("click",async()=>{
  const username=document.getElementById("signup-username").value;
  const email=document.getElementById("signup-email").value;
  const password=document.getElementById("signup-password").value;
  const cred = await createUserWithEmailAndPassword(auth,email,password);
  await setDoc(doc(db,"users",cred.user.uid),{username,role:"user",status:"Offline"});
});

loginBtn.addEventListener("click",async()=>{
  const email=document.getElementById("login-email").value;
  const password=document.getElementById("login-password").value;
  await signInWithEmailAndPassword(auth,email,password);
});

logoutBtn.addEventListener("click",()=>signOut(auth));

let currentUser;
onAuthStateChanged(auth,async user=>{
  if(user){
    currentUser=user;
    authScreen.classList.add("hidden");
    dashboardView.classList.remove("hidden");
    welcomeEl.textContent=`Hi, ${user.displayName||"User"}`;
    userEmailEl.textContent=user.email;
    const userDoc=await getDoc(doc(db,"users",user.uid));
    const userData=userDoc.data();
    if(userData.role==="owner") ownerPanel.classList.remove("hidden");
    else ownerPanel.classList.add("hidden");
    loadOrders();
    loadKeys();
    loadTickets();
    getOwnerStatus();
    messageInput.disabled=false;
    sendMsgBtn.disabled=false;
  } else {
    currentUser=null;
    authScreen.classList.remove("hidden");
    dashboardView.classList.add("hidden");
  }
});

// --- Redeem Key ---
redeemBtn.addEventListener("click",async()=>{
  const key=redeemInput.value.trim();
  if(!key) return alert("Enter key.");
  const keyDoc=await getDoc(doc(db,"keys",key));
  if(!keyDoc.exists()) return alert("Invalid key.");
  const data=keyDoc.data();
  if(data.used) return alert("Key already used.");
  await updateDoc(doc(db,"keys",key),{used:true,redeemedBy:currentUser.uid});
  await addDoc(collection(db,"orders"),{
    uid: currentUser.uid,
    product:data.product,
    redeemedAt:new Date(),
    status:"Pending",
    key
  });
  alert("Redeemed "+data.product);
  loadOrders();
  loadKeys();
});

// --- Orders ---
async function loadOrders(){
  ordersList.innerHTML="";
  const q=query(collection(db,"orders"),where("uid","==",currentUser.uid));
  const snap=await getDocs(q);
  if(snap.empty){ordersList.innerHTML="<tr><td colspan='4' style='color:var(--muted)'>No orders yet</td></tr>";return;}
  snap.forEach(doc=>{
    const d=doc.data();
    const tr=document.createElement("tr");
    const statusColor=d.status==="Pending"?"orange":"green";
    tr.innerHTML=`<td>${d.product}</td><td>${d.key}</td><td>${d.redeemedAt.toDate().toLocaleString()}</td><td style="color:${statusColor};font-weight:700">${d.status}</td>`;
    ordersList.appendChild(tr);
  });
}

// --- Create Key ---
createKeyBtn.addEventListener("click",async()=>{
  const code=ownerKeyCode.value.trim();
  const product=ownerKeyProduct.value.trim();
  if(!code||!product) return alert("Fill both fields.");
  await setDoc(doc(db,"keys",code),{product,used:false});
  ownerKeyCode.value="";ownerKeyProduct.value="";
  loadKeys();
});

// --- Load Keys ---
async function loadKeys(){
  keysList.innerHTML="";
  const snap=await getDocs(collection(db,"keys"));
  snap.forEach(doc=>{
    const d=doc.data();
    const tr=document.createElement("tr");
    const usedColor=d.used?"red":"green";
    tr.innerHTML=`<td>${doc.id}</td><td>${d.product}</td><td style="color:${usedColor};font-weight:700">${d.used}</td>
      <td><button onclick="deleteKey('${doc.id}')">Delete</button></td>`;
    keysList.appendChild(tr);
  });
});
window.deleteKey=async id=>{await updateDoc(doc(db,"keys",id),{used:true});loadKeys();};

// --- Tickets ---
async function loadTickets(){
  ticketsList.innerHTML="";
  const snap=await getDocs(collection(db,"tickets"));
  snap.forEach(doc=>{
    const t=doc.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${t.userId}</td><td>${t.product||"-"}</td><td>${t.key||"-"}</td><td>${t.status}</td>
      <td><button onclick="replyTicket('${doc.id}')">Reply</button>
      <button onclick="closeTicket('${doc.id}')">Close</button></td>`;
    ticketsList.appendChild(tr);
  });
}
window.closeTicket=async id=>{await updateDoc(doc(db,"tickets",id),{status:"closed"});loadTickets();};
window.replyTicket=async id=>{
  const msg=prompt("Reply message:");
  if(!msg) return;
  await updateDoc(doc(db,"tickets",id),{messages:arrayUnion({sender:"owner",text:msg,timestamp:new Date()})});
  loadTickets();
};

// --- Owner status ---
ownerStatusSelect.addEventListener("change",async()=>{
  await updateDoc(doc(db,"users",currentUser.uid),{status:ownerStatusSelect.value});
});
async function getOwnerStatus(){
  const q=query(collection(db,"users"),where("role","==","owner"));
  const snap=await getDocs(q);
  if(!snap.empty){
    const data=snap.docs[0].data();
    ownerStatusDisplay.textContent="Owner Status: "+data.status;
  }
}

// --- Messaging ---
sendMsgBtn.addEventListener("click",async()=>{
  const text=messageInput.value.trim();
  if(!text) return;
  const ticketQuery=query(collection(db,"tickets"),where("userId","==",currentUser.uid),where("status","==","open"));
  const snap=await getDocs(ticketQuery);
  let ticketId;
  if(snap.empty){
    const t=await addDoc(collection(db,"tickets"),{userId:currentUser.uid,status:"open",key:"-",messages:[]});
    ticketId=t.id;
  } else ticketId=snap.docs[0].id;
  await updateDoc(doc(db,"tickets",ticketId),{messages:arrayUnion({sender:"user",text,timestamp:new Date()})});
  messageInput.value="";
  alert("Message sent!");
  loadTickets();
});

</script>
</body>
</html>
