<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Konvy Accounts — Full Screen Dashboard</title>
<style>
:root{ --bg:#000; --fg:#fff; --muted:#bdbdbd; --accent:#fff; }
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:var(--fg);background:var(--bg);}
body{display:flex;flex-direction:column;}
header{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border-bottom:1px solid rgba(255,255,255,0.1);}
.logo{font-size:24px;font-weight:700;}
main{flex:1;display:flex;overflow:hidden;}
.sidebar{width:250px;background:rgba(255,255,255,0.05);padding:20px;display:flex;flex-direction:column;gap:12px;}
.sidebar button{background:transparent;border:1px solid rgba(255,255,255,0.1);padding:10px;border-radius:8px;color:var(--fg);cursor:pointer;text-align:left;font-weight:600;}
.sidebar button.active{background:var(--accent);color:var(--bg);}
.content{flex:1;padding:24px;overflow-y:auto;}
h2{margin-top:0;color:var(--accent);}
.card{background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;margin-bottom:12px;}
input,button{font-size:14px;}
input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:var(--fg);}
button{padding:10px;border:none;border-radius:8px;background:var(--fg);color:var(--bg);cursor:pointer;font-weight:700;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.2);}
.hidden{display:none;}
footer{height:40px;text-align:center;color:var(--muted);border-top:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;}
</style>
</head>
<body>
<header>
  <div class="logo">Konvy</div>
  <div>
    <span id="welcome">Welcome</span> | <span id="user-email">Not signed in</span>
    <button id="logout-btn" class="hidden">Logout</button>
  </div>
</header>
<main>
  <div class="sidebar">
    <button id="menu-dashboard" class="active">Dashboard</button>
    <button id="menu-redeem">Redeem Key</button>
    <button id="menu-orders">My Orders</button>
    <button id="menu-owner" class="hidden">Owner Panel</button>
  </div>
  <div class="content" id="main-content">
    <div id="dashboard-view">
      <h2>Dashboard</h2>
      <div class="card">Welcome to your account dashboard.</div>
    </div>

    <div id="redeem-view" class="hidden">
      <h2>Redeem Key</h2>
      <div class="card">
        <input type="text" id="redeem-key-input" placeholder="Enter product key">
        <button id="redeem-key-btn">Redeem</button>
      </div>
    </div>

    <div id="orders-view" class="hidden">
      <h2>My Orders</h2>
      <table id="orders-table">
        <thead>
          <tr><th>Redeemed At</th></tr>
        </thead>
        <tbody id="orders-list"></tbody>
      </table>
    </div>

    <div id="owner-view" class="hidden">
      <h2>Owner Panel</h2>
      <div class="card">
        <h4>Create Key</h4>
        <input type="text" id="owner-product-name" placeholder="Product Name">
        <input type="text" id="owner-key" placeholder="Key">
        <button id="create-key-btn">Create Key</button>
      </div>
      <div class="card">
        <h4>All Keys</h4>
        <table id="keys-table">
          <thead><tr><th>Key</th><th>Product</th><th>Status</th><th>Redeemed By</th></tr></thead>
          <tbody id="keys-list"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>
<footer>Built with Firebase — works across devices.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyD2M35gv68ILULRqlRVlO5E4oLCXbj1RaM",
  authDomain: "konvy-57910.firebaseapp.com",
  projectId: "konvy-57910",
  storageBucket: "konvy-57910.firebasestorage.app",
  messagingSenderId: "97699914787",
  appId: "1:97699914787:web:f2ba164292f3a3f07ebd96",
  measurementId: "G-330N3W9E4N"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Elements
const welcomeEl=document.getElementById('welcome');
const userEmailEl=document.getElementById('user-email');
const logoutBtn=document.getElementById('logout-btn');
const dashboardView=document.getElementById('dashboard-view');
const redeemView=document.getElementById('redeem-view');
const ordersView=document.getElementById('orders-view');
const ownerView=document.getElementById('owner-view');
const redeemInput=document.getElementById('redeem-key-input');
const redeemBtn=document.getElementById('redeem-key-btn');
const ordersList=document.getElementById('orders-list');
const ownerControlsBtn=document.getElementById('menu-owner');
const ownerProductName=document.getElementById('owner-product-name');
const ownerKeyInput=document.getElementById('owner-key');
const createKeyBtn=document.getElementById('create-key-btn');
const keysList=document.getElementById('keys-list');

// Menu buttons
document.getElementById('menu-dashboard').addEventListener('click',()=>switchView('dashboard'));
document.getElementById('menu-redeem').addEventListener('click',()=>switchView('redeem'));
document.getElementById('menu-orders').addEventListener('click',()=>switchView('orders'));
document.getElementById('menu-owner').addEventListener('click',()=>switchView('owner'));

function switchView(view){
  dashboardView.classList.add('hidden');
  redeemView.classList.add('hidden');
  ordersView.classList.add('hidden');
  ownerView.classList.add('hidden');
  document.querySelectorAll('.sidebar button').forEach(b=>b.classList.remove('active'));
  if(view==='dashboard'){dashboardView.classList.remove('hidden'); document.getElementById('menu-dashboard').classList.add('active');}
  if(view==='redeem'){redeemView.classList.remove('hidden'); document.getElementById('menu-redeem').classList.add('active');}
  if(view==='orders'){ordersView.classList.remove('hidden'); document.getElementById('menu-orders').classList.add('active');}
  if(view==='owner'){ownerView.classList.remove('hidden'); document.getElementById('menu-owner').classList.add('active');}
}

// Owner key
const OWNER_KEY="KDFIHFdawdd124345#$@#FIGwdwdaHE@";
db.collection("keys").doc(OWNER_KEY).get().then(doc=>{if(!doc.exists){db.collection("keys").doc(OWNER_KEY).set({product:"Owner Access", role:"owner", used:false});}});

// Redeem key
redeemBtn.addEventListener('click', async () => {
  const key = redeemInput.value.trim();
  if (!key) return alert("Enter key");
  const user = auth.currentUser;
  if (!user) return alert("You must be signed in");

  const keyDocRef = db.collection("keys").doc(key);
  const keyDoc = await keyDocRef.get();
  if (!keyDoc.exists) return alert("Invalid key");

  const keyData = keyDoc.data();
  if (keyData.used) return alert("This key has already been redeemed");

  // Mark key as used
  await keyDocRef.update({ used: true, redeemedBy: user.uid, redeemedAt: firebase.firestore.Timestamp.now() });

  if (keyData.role === "owner") {
    // Grant owner role
    await db.collection("users").doc(user.uid).set({ role: "owner", username: user.displayName || user.email }, { merge: true });
    alert("Owner role granted!");
    ownerControlsBtn.classList.remove('hidden');
  } else {
    // Add order to orders collection
    await db.collection("orders").add({
      userId: user.uid,
      key: key,
      redeemedAt: firebase.firestore.Timestamp.now()
    });
    alert("Key redeemed successfully!");
  }

  redeemInput.value = "";
  loadOrders(); // refresh orders after redeem
  loadKeys();   // refresh owner keys view
});

// Load orders
async function loadOrders(){
  const user = auth.currentUser;
  if(!user) return;
  const snapshot = await db.collection("orders").where("userId","==",user.uid).orderBy("redeemedAt","desc").get();
  ordersList.innerHTML="";
  if(snapshot.empty){ordersList.innerHTML="<tr><td style='color:var(--muted)'>No orders yet</td></tr>";return;}
  snapshot.forEach(doc=>{
    const d=doc.data();
    const date=d.redeemedAt.toDate().toLocaleString();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${date}</td>`;
    ordersList.appendChild(tr);
  });
}

// Owner create key
createKeyBtn.addEventListener('click', async () => {
  const product = ownerProductName.value.trim();
  const key = ownerKeyInput.value.trim();
  if(!product || !key) return alert("Fill all fields");
  await db.collection("keys").doc(key).set({product, role:"user", used:false});
  alert("Key created!");
  ownerProductName.value = ""; ownerKeyInput.value = "";
  loadKeys();
});

// Load keys for owner
async function loadKeys(){
  const snapshot = await db.collection("keys").get();
  keysList.innerHTML="";
  snapshot.forEach(doc=>{
    const d=doc.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${doc.id}</td><td>${d.product}</td><td>${d.used?"Used":"Unused"}</td><td>${d.redeemedBy||"-"}</td>`;
    keysList.appendChild(tr);
  });
}

// Logout
logoutBtn.addEventListener('click', async()=>{await auth.signOut(); location.reload();});

// Auth state
auth.onAuthStateChanged(async user=>{
  if(user){
    const userDoc=await db.collection("users").doc(user.uid).get();
    const userData=userDoc.data();
    welcomeEl.textContent=`Hi, ${userData?.username || user.email}`;
    userEmailEl.textContent=user.email;
    logoutBtn.classList.remove('hidden');
    if(userData?.role==="owner") ownerControlsBtn.classList.remove('hidden');
    loadOrders(); loadKeys();
  }else{
    welcomeEl.textContent="Welcome"; userEmailEl.textContent="Not signed in"; logoutBtn.classList.add('hidden');
  }
});
</script>
</body>
</html>
